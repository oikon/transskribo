# Transskribo — Progress Log
#
# Format:
#   Each entry is a block with the following fields:
#
#   ## YYYY-MM-DD HH:MM — Session N: <title>
#   Features: <comma-separated requirement IDs completed>
#   Status: success | partial | failed
#   Notes:
#     - <what was done>
#     - <what was done>
#   Issues:
#     - <any problems encountered, or "none">
#
# This file is updated by each headless session after completing work.
# It serves as a handoff log between sessions.

## 2026-02-12 — Session 1: Project Skeleton & Configuration
Features: 1.01, 1.02, 1.03, 2.01, 2.02, 2.03, 2.04, 2.05
Status: success
Notes:
  - Created pyproject.toml with all dependencies and entry point
  - Created src/transskribo/__init__.py with __version__
  - Created src/transskribo/cli.py with Typer app and placeholder run command
  - Created .gitignore for Python project
  - Created config.example.toml with all documented options
  - Created tests/conftest.py with shared fixtures (tmp dirs, sample config)
  - Implemented TransskriboConfig frozen dataclass with all fields and defaults
  - Implemented load_config() for TOML parsing
  - Implemented merge_config() with defaults < file < CLI override priority
  - Implemented config validation (input_dir exists, output_dir creatable, hf_token required)
  - HF_TOKEN env var fallback works correctly
  - Wrote 20 tests covering all config functionality
  - All tests pass, ruff clean, pyright clean
Issues:
  - none

## 2026-02-12 — Session 2: Logging, File Scanner & Validation
Features: 3.01, 3.02, 4.01, 4.02, 4.03, 5.01, 5.02, 5.03
Status: success
Notes:
  - Implemented setup_logging() in logging_setup.py with rich stdout + rotating file handler
  - Wrote 6 tests for logging (handler attachment, file creation, message routing, level filtering)
  - Implemented AudioFile frozen dataclass and scan_directory() in scanner.py
  - Supports 14 extensions (8 audio + 6 video), case-insensitive, with mirrored output paths
  - Implemented filter_already_processed() to skip files with existing output
  - Wrote 13 tests for scanner (empty dir, nested dirs, extensions, filtering, frozen dataclass)
  - Implemented ValidationResult frozen dataclass and check_ffprobe_available() in validator.py
  - Implemented validate_file() using ffprobe subprocess with all rejection checks
  - Wrote 14 tests for validator (zero-length, valid audio, video+audio, no audio, corrupt, max duration, timeout, invalid JSON, no duration)
  - All 53 tests pass, ruff clean, pyright clean
Issues:
  - none

## 2026-02-12 — Session 3: Hashing & Registry
Features: 6.01, 6.02, 6.03, 6.04
Status: success
Notes:
  - Implemented compute_hash() with streaming SHA-256 in hasher.py
  - Defined RegistryEntry frozen dataclass with all fields (source_path, output_path, timestamp, status, duration_audio_secs, timing, error)
  - Implemented load_registry() and save_registry() with atomic write (tempfile + rename)
  - Implemented lookup_hash() that returns entry only for status "success"
  - Implemented register_hash() that creates RegistryEntry and stores as dict
  - Wrote 22 tests covering hash determinism, registry CRUD, atomic write safety, lookup hit/miss/failed-status, register with timing data, full roundtrip
  - All 75 tests pass, ruff clean, pyright clean
Issues:
  - none

## 2026-02-12 — Session 4: Transcriber (WhisperX Wrapper)
Features: 7.01, 7.02, 7.03, 7.04, 7.05
Status: success
Notes:
  - Implemented load_audio() wrapping whisperx.load_audio() in transcriber.py
  - Implemented load_whisper_model(), transcribe(), align(), unload_whisper_model() for transcription stage
  - align() loads alignment model, runs alignment, then frees alignment model and clears VRAM
  - Implemented load_diarization_pipeline(), diarize(), assign_speakers(), unload_diarization_pipeline() for diarization stage
  - DiarizationPipeline imported from whisperx.diarize (not on top-level whisperx module)
  - Implemented process_file() orchestrator with per-stage timing via time.monotonic()
  - Models loaded/unloaded per stage with finally blocks ensuring VRAM cleanup on errors
  - Audio loaded once via load_audio(), ndarray passed to transcribe+align; pyannote takes audio_path
  - Wrote 15 mock tests covering: individual function args, VRAM cleanup, full lifecycle order, timing collection, error cleanup, models never loaded simultaneously
  - All 90 tests pass, ruff clean, pyright clean
Issues:
  - none

## 2026-02-12 — Session 5: Output Writer & Reporter
Features: 8.01, 8.02, 8.03, 9.01, 9.02, 9.03, 9.04, 9.05
Status: success
Notes:
  - Implemented build_output_document() in output.py structuring JSON with segments, words, metadata
  - Segments contain start, end, text, speaker, and nested words list
  - Words are flattened into a top-level list with start, end, word, score, speaker
  - Metadata includes source_file, file_hash, duration_secs, num_speakers, model_size, language, processed_at, timing
  - num_speakers auto-counted from unique speakers in segments if not provided in metadata
  - Implemented write_output() with atomic write (tempfile + rename) and parent dir creation
  - Implemented copy_duplicate_output() that copies output JSON and updates source_file + processed_at in metadata
  - Wrote 18 tests for output.py covering document structure, empty/missing segments, unicode, atomic write safety, duplicate copy
  - Implemented compute_statistics() in reporter.py reusing scan_directory for total file count
  - Implemented compute_timing_statistics() with per-stage avg/min/max, speed ratio (audio/processing), total count
  - Implemented per_directory_breakdown() grouping stats by top-level subdirectory relative to input_dir
  - Implemented format_report() rendering rich tables for progress, timing, and per-directory sections with ETA
  - Wrote 27 tests for reporter.py covering statistics computation, timing stats, breakdown grouping, report formatting
  - All 135 tests pass, ruff clean, pyright clean
Issues:
  - none
